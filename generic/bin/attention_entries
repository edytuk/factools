#!/usr/bin/env python

import sys

def main ():

    if len (sys.argv) < 2:
        print "Usage: %s <input file generated by analyze_entries>"
        print "           or '-' for reading from stdin."
        sys.exit(1)

    if sys.argv[1] == '-':
        from_analyze_entries = sys.stdin
    else:
        from_analyze_entries = open (sys.argv[1], 'r')

    print process_analysis (from_analyze_entries)


def process_analysis (file_object):

    output = []
    current_entries = []

    percentile_entries = 5

    gather_state_dict = {"out of entries": 0,
                         "in entries": 1}
    gather_state = gather_state_dict["out of entries"]

    for line in file_object:
        save_line = line.rstrip()

        if gather_state == gather_state_dict["out of entries"]:
        
            if line.count(r'%') == 7:
                del current_entries[:]
                start_fail_ratio = int( line.split()[1][:-1] )
                current_entries.append( (start_fail_ratio, save_line) )

                gather_state = gather_state_dict["in entries"]

            else:
                output.append (save_line)

        elif gather_state == gather_state_dict["in entries"]:

            if line.count(r'%') == 7:
                start_fail_ratio = int( line.split()[1][:-1] )
                current_entries.append( (start_fail_ratio, save_line) )

            else:
                current_entries.sort()
                current_entries.reverse()
                output.extend ([ e[1] for e in current_entries ][:percentile_entries])
                output.append (save_line)

                gather_state = gather_state_dict["out of entries"]

    return '\n'.join(output)

if __name__ == "__main__":
    main ()
